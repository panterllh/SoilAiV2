<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ระบบวิเคราะห์คุณภาพดินด้วย AI - วิเคราะห์ประเภทดิน ให้คำแนะนำการปลูกพืช">
    <title>SoilAI Pro - ระบบวิเคราะห์ดินอัจฉริยะ</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌱</text></svg>">
    
    <!-- TensorFlow.js - Load with specific version that works -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0"></script>
    
    <!-- jsPDF for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ============================================
           Variables & Reset
        ============================================ */
        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --primary-light: #34d399;
            --secondary-color: #3b82f6;
            --secondary-dark: #2563eb;
            --secondary-light: #60a5fa;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --text-color: #374151;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
            --gradient-hero: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
        }
        
        /* Dark mode variables */
        body.dark-mode {
            --dark-color: #111827;
            --light-color: #1f2937;
            --text-color: #f3f4f6;
            --text-light: #9ca3af;
            --border-color: #374151;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            background: #0f172a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            background: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease;
            overflow-x: hidden;
        }
        
        /* ============================================
           Preloader
        ============================================ */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        body.dark-mode .preloader {
            background: #0f172a;
        }
        
        .preloader-content {
            text-align: center;
        }
        
        .preloader-logo {
            font-size: 4rem;
            animation: bounce 1s infinite;
            margin-bottom: 1rem;
        }
        
        .preloader-text {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-bottom: 1rem;
        }
        
        .preloader-progress {
            width: 200px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }
        
        .preloader-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        /* ============================================
           Animations
        ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideInDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .animate-slideInUp { animation: slideInUp 0.5s ease-out; }
        .animate-slideInDown { animation: slideInDown 0.5s ease-out; }
        .animate-slideInLeft { animation: slideInLeft 0.5s ease-out; }
        .animate-slideInRight { animation: slideInRight 0.5s ease-out; }
        .animate-pulse { animation: pulse 2s ease-in-out infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        /* ============================================
           Header & Navigation
        ============================================ */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        body.dark-mode header {
            background: rgba(17, 24, 39, 0.95);
        }
        
        nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .logo i {
            animation: float 3s ease-in-out infinite;
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient-primary);
            transition: width 0.3s;
        }
        
        .nav-links a:hover::after {
            width: 100%;
        }
        
        /* Theme toggle */
        .theme-toggle {
            background: var(--light-color);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: rotate(180deg);
        }
        
        /* Mobile menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* ============================================
           Main Container
        ============================================ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }
        
        /* Hero Section */
        .hero {
            text-align: center;
            padding: 80px 40px;
            background: var(--gradient-hero);
            color: white;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            animation: slideInDown 0.8s ease-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .hero p {
            font-size: 1.3rem;
            opacity: 0.9;
            animation: slideInUp 0.8s ease-out;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .hero-cta {
            margin-top: 30px;
            animation: fadeIn 1s ease-out 0.5s both;
        }
        
        /* ============================================
           Feature Cards
        ============================================ */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .feature-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .feature-card {
            background: var(--light-color);
            border-color: var(--border-color);
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover::before {
            transform: translateX(0);
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .feature-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            animation: float 3s ease-in-out infinite;
        }
        
        .feature-card:nth-child(2) .feature-icon {
            background: var(--gradient-secondary);
            animation-delay: 1s;
        }
        
        .feature-card:nth-child(3) .feature-icon {
            background: linear-gradient(135deg, var(--accent-color), #dc2626);
            animation-delay: 2s;
        }
        
        .feature-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .feature-description {
            color: var(--text-light);
            line-height: 1.6;
        }
        
        /* ============================================
           Stats Cards
        ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .stat-card {
            background: var(--light-color);
            border-color: var(--border-color);
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover::after {
            transform: scaleX(1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }
        
        .stat-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: block;
            transition: var(--transition);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 5px;
            animation: slideInUp 0.8s ease-out;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* ============================================
           Main Grid Layout
        ============================================ */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        /* Card Component */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        body.dark-mode .card {
            background: var(--light-color);
            border-color: var(--border-color);
        }
        
        .card-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .card-header i {
            font-size: 1.8rem;
        }
        
        .card-body {
            padding: 30px;
        }
        
        /* ============================================
           Upload Section
        ============================================ */
        .upload-container {
            position: relative;
        }
        
        .upload-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .upload-option {
            padding: 25px;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--light-color);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .upload-option {
            background: var(--dark-color);
            border-color: var(--border-color);
        }
        
        .upload-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .upload-option:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .upload-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .upload-option i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
            transition: var(--transition);
        }
        
        .upload-option:hover i {
            transform: scale(1.2);
        }
        
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--light-color);
            position: relative;
        }
        
        body.dark-mode .upload-area {
            background: var(--dark-color);
            border-color: var(--border-color);
        }
        
        .upload-area.dragover {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--primary-color);
            transform: scale(1.02);
        }
        
        #imageInput {
            display: none;
        }
        
        /* Preview Section */
        .preview-container {
            margin-top: 20px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        #previewImage {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        
        #previewImage:hover {
            transform: scale(1.05);
        }
        
        /* ============================================
           Results Section
        ============================================ */
        .result-display {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .soil-result {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .soil-result {
            background: linear-gradient(135deg, #1f2937, #111827);
        }
        
        .soil-result::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        .soil-icon {
            font-size: 5rem;
            margin-bottom: 15px;
            display: block;
            animation: bounceIn 0.8s ease-out;
            position: relative;
            z-index: 1;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .soil-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .confidence-container {
            margin: 20px auto;
            max-width: 400px;
            position: relative;
            z-index: 1;
        }
        
        .confidence-bar {
            background: rgba(229, 231, 235, 0.5);
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .confidence-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }
        
        .confidence-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Soil Properties Grid */
        .soil-properties {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 25px;
            position: relative;
            z-index: 1;
        }
        
        .property-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        
        body.dark-mode .property-card {
            background: var(--dark-color);
            border-color: var(--border-color);
        }
        
        .property-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .property-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
            transition: var(--transition);
        }
        
        .property-card:hover .property-icon {
            transform: scale(1.1);
        }
        
        .property-card h4 {
            margin: 5px 0;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .property-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        /* Recommendations */
        .recommendations {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
            padding: 25px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }
        
        body.dark-mode .recommendations {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.08));
        }
        
        .recommendations h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        
        body.dark-mode .recommendation-item {
            background: var(--dark-color);
        }
        
        .recommendation-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }
        
        .recommendation-item i {
            color: var(--primary-color);
            font-size: 1.3rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        /* Plant Cards */
        .plant-card {
            background: white;
            color: var(--text-color);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .plant-card {
            background: var(--light-color);
            border-color: var(--border-color);
        }
        
        .plant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .plant-card:hover::before {
            opacity: 0.1;
        }
        
        .plant-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .plant-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
        }
        
        .plant-name {
            font-weight: 600;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .plant-type {
            font-size: 0.85rem;
            opacity: 0.7;
            position: relative;
            z-index: 1;
        }
        
        /* ============================================
           Buttons
        ============================================ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow);
        }
        
        .btn-primary {
            background: var(--gradient-primary);
        }
        
        .btn-secondary {
            background: var(--gradient-secondary);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        /* ============================================
           Loading States
        ============================================ */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 4px solid rgba(16, 185, 129, 0.1);
            border-radius: 50%;
        }
        
        .spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ============================================
           Messages & Alerts
        ============================================ */
        .alert {
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            margin: 15px 0;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideInDown 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }
        
        .alert-error {
            background: #fee;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        body.dark-mode .alert-error {
            background: rgba(220, 38, 38, 0.1);
            border-color: rgba(220, 38, 38, 0.3);
        }
        
        body.dark-mode .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        body.dark-mode .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        /* ============================================
           Modal
        ============================================ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            position: relative;
            background: white;
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: var(--border-radius);
            animation: slideInUp 0.3s;
            box-shadow: var(--shadow-xl);
        }
        
        body.dark-mode .modal-content {
            background: var(--light-color);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: var(--light-color);
            color: var(--danger-color);
            transform: rotate(90deg);
        }
        
        #cameraVideo {
            width: 100%;
            border-radius: var(--border-radius-sm);
            background: #000;
        }
        
        .camera-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* ============================================
           History Section
        ============================================ */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow);
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
        }
        
        .history-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .history-table tr {
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .history-table tbody tr:hover {
            background: rgba(16, 185, 129, 0.05);
            transform: scale(1.01);
        }
        
        body.dark-mode .history-table tr {
            border-bottom-color: var(--border-color);
        }
        
        body.dark-mode .history-table tbody tr:hover {
            background: rgba(16, 185, 129, 0.1);
        }
        
        /* ============================================
           Footer
        ============================================ */
        footer {
            background: var(--dark-color);
            color: white;
            text-align: center;
            padding: 60px 20px;
            margin-top: 80px;
            position: relative;
            overflow: hidden;
        }
        
        footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
            text-align: left;
        }
        
        .footer-section h4 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .footer-links a:hover {
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 40px;
        }
        
        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .social-links a {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: var(--transition);
        }
        
        .social-links a:hover {
            background: var(--primary-color);
            transform: translateY(-3px);
        }
        
        /* ============================================
           Toast Notifications
        ============================================ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }
        
        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-lg);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--primary-color);
        }
        
        body.dark-mode .toast {
            background: var(--light-color);
        }
        
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.info { border-left-color: var(--secondary-color); }
        
        .toast-icon {
            font-size: 1.5rem;
        }
        
        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.info .toast-icon { color: var(--secondary-color); }
        
        /* ============================================
           Responsive Design
        ============================================ */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1.1rem;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .upload-methods {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                display: none;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .soil-properties {
                grid-template-columns: 1fr;
            }
            
            .footer-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .toast {
                min-width: 250px;
                right: 10px;
                left: 10px;
            }
        }
        
        /* ============================================
           Utilities
        ============================================ */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        
        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        
        /* Selection color */
        ::selection {
            background: var(--primary-color);
            color: white;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-color);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        body.dark-mode ::-webkit-scrollbar-track {
            background: var(--dark-color);
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader" id="preloader">
        <div class="preloader-content">
            <div class="preloader-logo">🌱</div>
            <h2 class="preloader-text">กำลังโหลดระบบ SoilAI</h2>
            <div class="preloader-progress">
                <div class="preloader-progress-bar" id="preloaderBar"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Header -->
    <header>
        <nav>
            <a href="#home" class="logo">
                <i class="fas fa-seedling"></i>
                SoilAI Pro
            </a>
            <div class="nav-links">
                <a href="#home">หน้าแรก</a>
                <a href="#features">คุณสมบัติ</a>
                <a href="#analyze">วิเคราะห์</a>
                <a href="#history">ประวัติ</a>
                <a href="#about">เกี่ยวกับ</a>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
            <button class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </nav>
    </header>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section -->
        <section class="hero" id="home">
            <div class="hero-content">
                <h1>🌱 ระบบวิเคราะห์ดินอัจฉริยะ</h1>
                <p>ใช้ AI ช่วยวิเคราะห์ประเภทดินและให้คำแนะนำการปลูกพืชที่เหมาะสม พร้อมระบบติดตามผลแบบเรียลไทม์</p>
                <div class="hero-cta">
                    <a href="#analyze" class="btn btn-primary">
                        <i class="fas fa-microscope"></i> เริ่มวิเคราะห์
                    </a>
                    <a href="#features" class="btn btn-secondary">
                        <i class="fas fa-info-circle"></i> ดูรายละเอียด
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Features Section -->
        <section class="features-grid" id="features">
            <div class="feature-card animate-slideInLeft">
                <div class="feature-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h3 class="feature-title">AI ที่ชาญฉลาด</h3>
                <p class="feature-description">ใช้โมเดล Deep Learning ที่ผ่านการฝึกอบรมด้วยข้อมูลดินกว่า 1,000 ตัวอย่าง</p>
            </div>
            <div class="feature-card animate-slideInUp">
                <div class="feature-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h3 class="feature-title">วิเคราะห์ทันที</h3>
                <p class="feature-description">ได้ผลการวิเคราะห์ภายในไม่กี่วินาที พร้อมคำแนะนำที่ใช้ได้จริง</p>
            </div>
            <div class="feature-card animate-slideInRight">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="feature-title">ติดตามผลต่อเนื่อง</h3>
                <p class="feature-description">บันทึกประวัติการวิเคราะห์ เปรียบเทียบผล และติดตามการเปลี่ยนแปลง</p>
            </div>
        </section>
        
        <!-- Stats Grid -->
        <section class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-chart-line stat-icon"></i>
                <div class="stat-value" id="accuracyStat">0%</div>
                <div class="stat-label">ความแม่นยำ</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-images stat-icon"></i>
                <div class="stat-value" id="imagesStat">0</div>
                <div class="stat-label">รูปที่ใช้ฝึก</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-layer-group stat-icon"></i>
                <div class="stat-value">3</div>
                <div class="stat-label">ประเภทดิน</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock stat-icon"></i>
                <div class="stat-value" id="analyzeCount">0</div>
                <div class="stat-label">วิเคราะห์แล้ว</div>
            </div>
        </section>
        
        <!-- Main Grid -->
        <section class="main-grid" id="analyze">
            <!-- Upload Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-upload"></i>
                    <h2>อัพโหลดรูปดิน</h2>
                </div>
                <div class="card-body">
                    <div class="upload-container">
                        <!-- Upload Methods -->
                        <div class="upload-methods">
                            <div class="upload-option" onclick="document.getElementById('imageInput').click()">
                                <i class="fas fa-file-image"></i>
                                <p>เลือกจากไฟล์</p>
                            </div>
                            <div class="upload-option" onclick="openCamera()">
                                <i class="fas fa-camera"></i>
                                <p>ถ่ายรูป</p>
                            </div>
                        </div>
                        
                        <!-- Drag & Drop Area -->
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary-color);"></i>
                            <p style="margin: 10px 0; font-weight: 500;">ลากไฟล์มาวางที่นี่</p>
                            <p style="font-size: 0.9rem; color: var(--text-light);">รองรับ JPG, PNG ไม่เกิน 10MB</p>
                        </div>
                        
                        <input type="file" id="imageInput" accept="image/*">
                        
                        <!-- Preview -->
                        <div class="preview-container" id="previewContainer">
                            <img id="previewImage" alt="Preview">
                        </div>
                        
                        <!-- Loading -->
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p>กำลังวิเคราะห์ดิน...</p>
                        </div>
                        
                        <!-- Messages -->
                        <div class="alert alert-error" id="errorMessage">
                            <i class="fas fa-exclamation-circle"></i>
                            <span></span>
                        </div>
                        <div class="alert alert-success" id="successMessage">
                            <i class="fas fa-check-circle"></i>
                            <span></span>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="analyzeImage()" id="analyzeBtn" style="display: none;">
                                <i class="fas fa-search"></i> วิเคราะห์
                            </button>
                            <button class="btn btn-secondary" onclick="resetUpload()">
                                <i class="fas fa-redo"></i> เริ่มใหม่
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-poll"></i>
                    <h2>ผลการวิเคราะห์</h2>
                </div>
                <div class="card-body">
                    <div class="result-display" id="resultDisplay">
                        <div class="soil-result">
                            <div class="soil-icon" id="soilIcon">
                                <i class="fas fa-question-circle" style="font-size: 5rem;"></i>
                            </div>
                            <h3 class="soil-name" id="soilName">-</h3>
                            <div class="confidence-container">
                                <p style="margin-bottom: 10px; font-weight: 500;">ความมั่นใจในผลการวิเคราะห์</p>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" id="confidenceFill" style="width: 0%">0%</div>
                                </div>
                            </div>
                            
                            <!-- Soil Properties -->
                            <div class="soil-properties">
                                <div class="property-card">
                                    <i class="fas fa-flask property-icon" style="color: #3b82f6;"></i>
                                    <h4 style="color: #3b82f6;">ค่า pH</h4>
                                    <div class="property-value" id="phValue">-</div>
                                </div>
                                <div class="property-card">
                                    <i class="fas fa-tint property-icon" style="color: #10b981;"></i>
                                    <h4 style="color: #10b981;">ความชื้น</h4>
                                    <div class="property-value" id="moistureValue">-</div>
                                </div>
                                <div class="property-card">
                                    <i class="fas fa-thermometer-half property-icon" style="color: #ef4444;"></i>
                                    <h4 style="color: #ef4444;">อุณหภูมิ</h4>
                                    <div class="property-value" id="tempValue">-</div>
                                    <small style="color: var(--text-light);">°C</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="recommendations">
                            <h3><i class="fas fa-lightbulb"></i> คำแนะนำการดูแลดิน</h3>
                            <div id="recommendationsList"></div>
                        </div>
                        
                        <!-- Suitable Plants Section -->
                        <div class="recommendations">
                            <h3><i class="fas fa-leaf"></i> พืชที่เหมาะสมกับดินประเภทนี้</h3>
                            <div id="suitablePlantsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;"></div>
                        </div>
                        
                        <!-- Export Buttons -->
                        <div class="btn-group mt-20">
                            <button class="btn btn-primary" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> ดาวน์โหลด PDF
                            </button>
                            <button class="btn btn-secondary" onclick="shareResult()">
                                <i class="fas fa-share-alt"></i> แชร์ผล
                            </button>
                            <button class="btn btn-success" onclick="saveToHistory()">
                                <i class="fas fa-save"></i> บันทึกประวัติ
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div class="text-center" id="emptyResult">
                        <i class="fas fa-microscope" style="font-size: 4rem; color: #e5e7eb; margin-bottom: 20px;"></i>
                        <p style="color: var(--text-light); font-size: 1.1rem;">ยังไม่มีผลการวิเคราะห์</p>
                        <p style="color: var(--text-light); font-size: 0.9rem;">อัพโหลดรูปดินเพื่อเริ่มการวิเคราะห์</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- History Section -->
        <section class="card" id="history">
            <div class="card-header">
                <i class="fas fa-history"></i>
                <h2>ประวัติการวิเคราะห์</h2>
            </div>
            <div class="card-body">
                <div class="btn-group mb-20">
                    <button class="btn btn-primary" onclick="exportHistory('csv')">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportHistory('json')">
                        <i class="fas fa-file-code"></i> Export JSON
                    </button>
                    <button class="btn btn-danger" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> ล้างประวัติ
                    </button>
                </div>
                
                <div id="historyContent">
                    <p class="text-center" style="color: var(--text-light);">ยังไม่มีประวัติการวิเคราะห์</p>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Camera Modal -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-camera"></i> ถ่ายรูปดิน</h3>
                <button class="close-modal" onclick="closeCamera()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <video id="cameraVideo" autoplay></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div class="camera-controls">
                <button class="btn btn-primary" onclick="capturePhoto()">
                    <i class="fas fa-camera"></i> ถ่ายรูป
                </button>
                <button class="btn btn-secondary" onclick="switchCamera()">
                    <i class="fas fa-sync-alt"></i> สลับกล้อง
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer id="about">
        <div class="footer-content">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4><i class="fas fa-seedling"></i> SoilAI Pro</h4>
                    <p>ระบบวิเคราะห์ดินอัจฉริยะด้วย AI ที่ช่วยให้เกษตรกรไทยปลูกพืชได้อย่างมีประสิทธิภาพ</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>ลิงก์ด่วน</h4>
                    <ul class="footer-links">
                        <li><a href="#home"><i class="fas fa-angle-right"></i> หน้าแรก</a></li>
                        <li><a href="#features"><i class="fas fa-angle-right"></i> คุณสมบัติ</a></li>
                        <li><a href="#analyze"><i class="fas fa-angle-right"></i> วิเคราะห์ดิน</a></li>
                        <li><a href="#history"><i class="fas fa-angle-right"></i> ประวัติ</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>ติดต่อเรา</h4>
                    <ul class="footer-links">
                        <li><i class="fas fa-map-marker-alt"></i> กรุงเทพมหานคร, ประเทศไทย</li>
                        <li><i class="fas fa-phone"></i> 02-XXX-XXXX</li>
                        <li><i class="fas fa-envelope"></i> info@soilai.com</li>
                        <li><i class="fas fa-clock"></i> จันทร์-ศุกร์ 9:00-18:00</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 SoilAI Pro - ระบบวิเคราะห์ดินอัจฉริยะ | พัฒนาด้วย ❤️ เพื่อเกษตรกรไทย</p>
            </div>
        </div>
    </footer>
    
    <script>
        // ============================================
        // Global Variables
        // ============================================
        let model = null;
        let cameraStream = null;
        let currentCamera = 'environment';
        let analysisHistory = [];
        let analyzeCount = 0;
        let isModelReady = false;
        let isTensorFlowReady = false;
        
        // Soil type data
        const soilTypes = {
            0: {
                name: 'ดินร่วน',
                nameEn: 'Loam',
                icon: 'fa-seedling',
                iconText: '🌾',
                color: '#8B4513',
                phRange: { min: 6.0, max: 7.0 },
                moisture: 'ปกติ',
                tempRange: { min: 25, max: 30 },
                recommendations: [
                    { icon: 'fa-check-circle', text: 'เหมาะสำหรับปลูกพืชทั่วไป เช่น ผัก ไม้ดอก ไม้ผล' },
                    { icon: 'fa-tint', text: 'การระบายน้ำและอุ้มน้ำสมดุล รดน้ำ 2-3 วันครั้ง' },
                    { icon: 'fa-seedling', text: 'ควรใส่ปุ๋ยอินทรีย์หรือปุ๋ยคอก 2-3 กก./ตร.ม.' },
                    { icon: 'fa-chart-line', text: 'pH ที่เหมาะสม: 6.0-7.0 ใช้ปูนขาวปรับถ้า pH ต่ำ' },
                    { icon: 'fa-thermometer-half', text: 'อุณหภูมิที่เหมาะสม: 25-30°C' }
                ],
                suitablePlants: [
                    { name: 'ข้าวหอมมะลิ', icon: '🌾', type: 'พืชไร่' },
                    { name: 'มะเขือเทศ', icon: '🍅', type: 'ผัก' },
                    { name: 'พริก', icon: '🌶️', type: 'ผัก' },
                    { name: 'ผักบุ้ง', icon: '🥬', type: 'ผัก' },
                    { name: 'คะน้า', icon: '🥦', type: 'ผัก' },
                    { name: 'มะม่วง', icon: '🥭', type: 'ไม้ผล' },
                    { name: 'มะละกอ', icon: '🟠', type: 'ไม้ผล' },
                    { name: 'กล้วยน้ำว้า', icon: '🍌', type: 'ไม้ผล' },
                    { name: 'ดาวเรือง', icon: '🏵️', type: 'ไม้ดอก' },
                    { name: 'บานชื่น', icon: '🌺', type: 'ไม้ดอก' }
                ]
            },
            1: {
                name: 'ดินทราย',
                nameEn: 'Sand',
                icon: 'fa-umbrella-beach',
                iconText: '🏜️',
                color: '#F4A460',
                phRange: { min: 5.5, max: 7.0 },
                moisture: 'แห้ง',
                tempRange: { min: 28, max: 35 },
                recommendations: [
                    { icon: 'fa-tint', text: 'ต้องรดน้ำบ่อย (ทุกวัน) เพราะระบายน้ำเร็ว' },
                    { icon: 'fa-leaf', text: 'ควรผสมปุ๋ยคอกหรือปุ๋ยหมัก 3-5 กก./ตร.ม.' },
                    { icon: 'fa-carrot', text: 'เหมาะกับพืชรากลึก เช่น แครอท หัวไชเท้า มันฝรั่ง' },
                    { icon: 'fa-chart-line', text: 'pH ที่พบ: 5.5-7.0 ควรตรวจสอบบ่อย' },
                    { icon: 'fa-sun', text: 'ระวังการสูญเสียความชื้น ควรคลุมดิน' }
                ],
                suitablePlants: [
                    { name: 'มันสำปะหลัง', icon: '🌱', type: 'พืชไร่' },
                    { name: 'อ้อย', icon: '🎋', type: 'พืชไร่' },
                    { name: 'สับปะรด', icon: '🍍', type: 'ไม้ผล' },
                    { name: 'แตงโม', icon: '🍉', type: 'ผลไม้' },
                    { name: 'มะพร้าว', icon: '🥥', type: 'ไม้ผล' },
                    { name: 'ถั่วลิสง', icon: '🥜', type: 'พืชไร่' },
                    { name: 'มันเทศ', icon: '🍠', type: 'พืชหัว' },
                    { name: 'แครอท', icon: '🥕', type: 'พืชหัว' },
                    { name: 'หน่อไม้ฝรั่ง', icon: '🌿', type: 'ผัก' },
                    { name: 'ว่านหางจระเข้', icon: '🌵', type: 'สมุนไพร' }
                ]
            },
            2: {
                name: 'ดินเหนียว',
                nameEn: 'Clay',
                icon: 'fa-cube',
                iconText: '🟫',
                color: '#654321',
                phRange: { min: 5.0, max: 6.5 },
                moisture: 'ชื้น',
                tempRange: { min: 22, max: 28 },
                recommendations: [
                    { icon: 'fa-water', text: 'อุ้มน้ำดีแต่ระบายน้ำช้า รดน้ำ 4-5 วันครั้ง' },
                    { icon: 'fa-mountain', text: 'ควรผสมทรายหยาบหรือแกลบ 20-30%' },
                    { icon: 'fa-tractor', text: 'ต้องไถพรวนให้ดีก่อนปลูก เพิ่มอากาศในดิน' },
                    { icon: 'fa-chart-line', text: 'pH ที่พบ: 5.0-6.5 อาจต้องใช้ปูนขาว' },
                    { icon: 'fa-exclamation-triangle', text: 'ระวังน้ำท่วมขัง ควรยกแปลงปลูก' }
                ],
                suitablePlants: [
                    { name: 'ข้าวเหนียว', icon: '🌾', type: 'พืชไร่' },
                    { name: 'บัว', icon: '🪷', type: 'ไม้น้ำ' },
                    { name: 'ผักบุ้งน้ำ', icon: '🥬', type: 'ผักน้ำ' },
                    { name: 'ผักกระเฉด', icon: '🌿', type: 'ผักน้ำ' },
                    { name: 'ขิง', icon: '🫚', type: 'สมุนไพร' },
                    { name: 'ข่า', icon: '🌱', type: 'สมุนไพร' },
                    { name: 'ตะไคร้', icon: '🌾', type: 'สมุนไพร' },
                    { name: 'กล้วยหอม', icon: '🍌', type: 'ไม้ผล' },
                    { name: 'มะนาว', icon: '🍋', type: 'ไม้ผล' },
                    { name: 'ชมพู่', icon: '🍎', type: 'ไม้ผล' }
                ]
            }
        };
        
        // Wait for TensorFlow.js to be ready
        function waitForTensorFlow() {
            return new Promise((resolve) => {
                if (typeof tf !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(() => {
                        waitForTensorFlow().then(resolve);
                    }, 100);
                }
            });
        }
        
        // Initialize app with proper error handling
        async function initializeApp() {
            try {
                // Update preloader progress
                updatePreloaderProgress(10);
                
                // Wait for TensorFlow.js
                await waitForTensorFlow();
                console.log('TensorFlow.js loaded:', tf.version.tfjs);
                isTensorFlowReady = true;
                updatePreloaderProgress(20);
                
                // Set backend before loading model
                await tf.ready();
                console.log('TensorFlow backend:', tf.getBackend());
                updatePreloaderProgress(30);
                
                // Load theme
                checkTheme();
                updatePreloaderProgress(40);
                
                // Setup event listeners
                setupEventListeners();
                updatePreloaderProgress(50);
                
                // Load model with proper error handling
                await loadModel();
                updatePreloaderProgress(80);
                
                // Load history
                loadHistory();
                updatePreloaderProgress(90);
                
                // Update stats
                updateStats();
                updatePreloaderProgress(100);
                
                // Hide preloader
                setTimeout(() => {
                    hidePreloader();
                    showToast('ระบบพร้อมใช้งาน', 'success');
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                hidePreloader();
                
                // Still allow app to function with mock model
                model = createMockModel();
                isModelReady = true;
                
                showToast('ระบบทำงานในโหมดจำลอง', 'info');
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Check and clean storage first
            await checkAndCleanStorage();
            
            showPreloader();
            await initializeApp();
        });
        
        async function checkAndCleanStorage() {
            try {
                // Check storage size
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const storageEstimate = await navigator.storage.estimate();
                    const usedMB = (storageEstimate.usage / 1024 / 1024).toFixed(2);
                    const quotaMB = (storageEstimate.quota / 1024 / 1024).toFixed(2);
                    
                    console.log(`Storage: ${usedMB} MB / ${quotaMB} MB used`);
                    
                    // If using more than 50MB, clean up
                    if (storageEstimate.usage > 50 * 1024 * 1024) {
                        console.log('Cleaning up storage...');
                        clearOldData();
                    }
                }
            } catch (e) {
                console.log('Cannot check storage:', e);
            }
        }
        
        // Preloader functions
        function showPreloader() {
            document.getElementById('preloader').style.display = 'flex';
        }
        
        function hidePreloader() {
            const preloader = document.getElementById('preloader');
            preloader.style.opacity = '0';
            setTimeout(() => {
                preloader.style.display = 'none';
            }, 500);
        }
        
        function updatePreloaderProgress(percent) {
            document.getElementById('preloaderBar').style.width = percent + '%';
        }
        
        // Load TensorFlow model with better error handling
        async function loadModel() {
            try {
                // Check if TensorFlow is ready
                if (!isTensorFlowReady) {
                    throw new Error('TensorFlow.js not ready');
                }
                
                // Update preloader text
                document.querySelector('.preloader-text').textContent = 'กำลังโหลด AI Model...';
                
                // Try multiple paths for the model
                const modelPaths = [
                    './tfjs_model/model.json',
                    '/tfjs_model/model.json',
                    'tfjs_model/model.json',
                    '../tfjs_model/model.json',
                    './SoilAiV2/tfjs_model/model.json'
                ];
                
                let modelLoaded = false;
                let loadError = null;
                
                // Try each path
                for (const path of modelPaths) {
                    try {
                        console.log('Attempting to load model from:', path);
                        
                        // First check if the path exists
                        const response = await fetch(path);
                        if (response.ok) {
                            // Try to load the model
                            model = await tf.loadLayersModel(path);
                            modelLoaded = true;
                            isModelReady = true;
                            console.log('✅ Model loaded successfully from:', path);
                            
                            // Warmup the model with a dummy prediction
                            const dummyInput = tf.zeros([1, 224, 224, 3]);
                            await model.predict(dummyInput).data();
                            dummyInput.dispose();
                            
                            break;
                        }
                    } catch (error) {
                        loadError = error;
                        console.log('Failed to load from', path, ':', error.message);
                        continue;
                    }
                }
                
                if (!modelLoaded) {
                    console.warn('⚠️ Could not load real model, using simulation mode');
                    console.log('Last error:', loadError);
                    
                    // Create mock model that simulates real predictions
                    model = createMockModel();
                    isModelReady = true;
                    
                    // Show info message
                    setTimeout(() => {
                        showToast('ใช้โหมดจำลองเนื่องจากไม่พบไฟล์ Model บน Server', 'info');
                    }, 2000);
                }
                
                // Update stats
                animateValue('accuracyStat', 0, 96, 2000);
                animateValue('imagesStat', 0, 180, 2000);
                
            } catch (error) {
                console.error('Critical error loading model:', error);
                
                // Use mock model as fallback
                model = createMockModel();
                isModelReady = true;
                
                showToast('ใช้โหมดจำลอง AI', 'info');
            }
        }
        
        // Create mock model for demonstration
        function createMockModel() {
            return {
                isMock: true, // Flag to identify mock model
                predict: function(tensor) {
                    return {
                        data: async function() {
                            // Simulate processing time
                            await new Promise(resolve => setTimeout(resolve, 1500));
                            
                            // Generate random predictions based on simple logic
                            const rand = Math.random();
                            let predictions = [0, 0, 0];
                            
                            if (rand < 0.33) {
                                // Loam soil
                                predictions[0] = 0.7 + Math.random() * 0.25;
                                predictions[1] = Math.random() * 0.2;
                                predictions[2] = Math.random() * 0.1;
                            } else if (rand < 0.66) {
                                // Sandy soil
                                predictions[0] = Math.random() * 0.1;
                                predictions[1] = 0.75 + Math.random() * 0.2;
                                predictions[2] = Math.random() * 0.05;
                            } else {
                                // Clay soil
                                predictions[0] = Math.random() * 0.05;
                                predictions[1] = Math.random() * 0.1;
                                predictions[2] = 0.8 + Math.random() * 0.15;
                            }
                            
                            // Normalize to sum to 1
                            const sum = predictions.reduce((a, b) => a + b, 0);
                            predictions = predictions.map(p => p / sum);
                            
                            return predictions;
                        }
                    };
                },
                
                // Add dispose method for compatibility
                dispose: function() {
                    console.log('Mock model disposed');
                }
            };
        }
        
        // Animate number values
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                }
                
                if (id === 'accuracyStat') {
                    element.textContent = Math.floor(current) + '%';
                } else {
                    element.textContent = Math.floor(current).toLocaleString();
                }
            }, 16);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            
            // Click to upload
            uploadArea.addEventListener('click', () => imageInput.click());
            
            // File input change
            imageInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            // Smooth scroll for navigation links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Mobile menu toggle
            document.querySelector('.mobile-menu-toggle').addEventListener('click', () => {
                document.querySelector('.nav-links').classList.toggle('show');
            });
        }
        
        // ============================================
        // File Handling
        // ============================================
        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            handleSingleFile(files[0]);
        }
        
        function handleSingleFile(file) {
            if (!validateFile(file)) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewImage');
                preview.src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('analyzeBtn').style.display = 'inline-flex';
                document.getElementById('emptyResult').style.display = 'none';
                
                // Add animation
                preview.classList.add('animate-fadeIn');
            };
            reader.readAsDataURL(file);
        }
        
        function validateFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('กรุณาเลือกไฟล์รูปภาพ', 'error');
                return false;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showMessage('ไฟล์ใหญ่เกิน 10MB', 'error');
                return false;
            }
            
            return true;
        }
        
        // ============================================
        // Image Analysis with Memory Management
        // ============================================
        async function analyzeImage() {
            const preview = document.getElementById('previewImage');
            if (!preview.src || preview.src === window.location.href) {
                showMessage('กรุณาเลือกรูปก่อน', 'error');
                return;
            }
            
            // Show loading first
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analyzeBtn').style.display = 'none';
            
            try {
                // Wait for TensorFlow to be fully ready
                if (typeof tf !== 'undefined') {
                    await tf.ready();
                    console.log('TensorFlow backend ready:', tf.getBackend());
                }
                
                // Check if model is ready
                if (!isModelReady) {
                    // Try to create mock model if not ready
                    model = createMockModel();
                    isModelReady = true;
                }
                
                // Check storage quota
                if (!await checkStorageQuota()) {
                    clearOldData();
                }
                
                let tensor = null;
                let predictions = null;
                
                try {
                    // For mock model, don't use TensorFlow preprocessing
                    if (model.isMock) {
                        // Simple mock prediction without TensorFlow
                        predictions = await model.predict(null).data();
                    } else {
                        // Real model with TensorFlow
                        tensor = await preprocessImage(preview);
                        predictions = await model.predict(tensor).data();
                    }
                    
                    // Process results
                    const result = processResults(predictions);
                    
                    // Compress image before saving
                    result.imageData = await compressImage(preview.src);
                    result.timestamp = new Date();
                    
                    // Show results with animation
                    displayResults(result);
                    
                    // Update stats
                    analyzeCount++;
                    updateStats();
                    
                    // Save to recent analyses (auto-save last 3 only)
                    saveToRecent(result);
                    
                    showToast('วิเคราะห์เสร็จสิ้น', 'success');
                    
                } finally {
                    // Always dispose tensor to prevent memory leak
                    if (tensor && tensor.dispose) {
                        tensor.dispose();
                    }
                    
                    // Clean up TensorFlow memory if available
                    if (typeof tf !== 'undefined' && tf.disposeVariables) {
                        tf.disposeVariables();
                    }
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                
                // Try fallback to simple analysis
                try {
                    // Use mock model for simple analysis
                    const mockModel = createMockModel();
                    const predictions = await mockModel.predict(null).data();
                    const result = processResults(predictions);
                    
                    result.imageData = await compressImage(preview.src);
                    result.timestamp = new Date();
                    
                    displayResults(result);
                    analyzeCount++;
                    updateStats();
                    
                    showToast('วิเคราะห์เสร็จสิ้น (โหมดจำลอง)', 'info');
                } catch (fallbackError) {
                    console.error('Fallback analysis error:', fallbackError);
                    showMessage('เกิดข้อผิดพลาดในการวิเคราะห์', 'error');
                }
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('analyzeBtn').style.display = 'inline-flex';
            }
        }
        
        // Check storage quota
        async function checkStorageQuota() {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const {usage, quota} = await navigator.storage.estimate();
                    const percentUsed = (usage / quota) * 100;
                    console.log(`Storage: ${(usage / 1024 / 1024).toFixed(2)} MB / ${(quota / 1024 / 1024).toFixed(2)} MB (${percentUsed.toFixed(2)}%)`);
                    
                    // If more than 80% used, need cleanup
                    return percentUsed < 80;
                }
            } catch (e) {
                console.error('Cannot check storage quota:', e);
            }
            return true;
        }
        
        // Compress image to reduce storage
        async function compressImage(imageSrc) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Max dimensions
                    const maxWidth = 800;
                    const maxHeight = 600;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress as JPEG with 70% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = imageSrc;
            });
        }
        
        // Clear old data to free up space
        function clearOldData() {
            try {
                // Clear old history but keep recent 10
                let history = JSON.parse(localStorage.getItem('soilAnalysisHistory') || '[]');
                if (history.length > 10) {
                    history = history.slice(-10);
                    localStorage.setItem('soilAnalysisHistory', JSON.stringify(history));
                }
                
                // Clear recent analyses but keep last 3
                let recent = JSON.parse(localStorage.getItem('recentAnalyses') || '[]');
                if (recent.length > 3) {
                    recent = recent.slice(0, 3);
                    localStorage.setItem('recentAnalyses', JSON.stringify(recent));
                }
                
                // Clear other unnecessary data
                const keysToCheck = Object.keys(localStorage);
                keysToCheck.forEach(key => {
                    // Remove old/temporary data
                    if (key.startsWith('temp_') || key.startsWith('old_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                console.log('Old data cleared successfully');
            } catch (e) {
                console.error('Error clearing old data:', e);
            }
        }
        
        async function preprocessImage(imgElement) {
            // Check if TensorFlow is available
            if (typeof tf === 'undefined' || !tf.tidy) {
                throw new Error('TensorFlow.js not available');
            }
            
            // Wait for backend to be ready
            await tf.ready();
            
            return tf.tidy(() => {
                try {
                    // Convert image to tensor
                    let img = tf.browser.fromPixels(imgElement);
                    
                    // Resize to model input size (224x224)
                    img = tf.image.resizeBilinear(img, [224, 224]);
                    
                    // Normalize pixel values to [0, 1]
                    img = img.div(255.0);
                    
                    // Add batch dimension [1, 224, 224, 3]
                    return img.expandDims(0);
                } catch (error) {
                    console.error('Error in preprocessImage:', error);
                    throw error;
                }
            });
        }
        
        function processResults(predictions) {
            const maxIndex = predictions.indexOf(Math.max(...predictions));
            const confidence = predictions[maxIndex];
            const soilData = soilTypes[maxIndex];
            
            // Generate values
            const phMin = soilData.phRange.min;
            const phMax = soilData.phRange.max;
            const phValue = `${phMin}-${phMax}`;
            
            const moistureValue = soilData.moisture;
            
            const tempMin = soilData.tempRange.min;
            const tempMax = soilData.tempRange.max;
            const tempValue = `${tempMin}-${tempMax}`;
            
            return {
                soilType: maxIndex,
                soilData: soilData,
                confidence: confidence,
                allPredictions: Array.from(predictions),
                phValue: phValue,
                moistureValue: moistureValue,
                tempValue: tempValue
            };
        }
        
        // ============================================
        // Display Results
        // ============================================
        function displayResults(result) {
            // Show result section with animation
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.style.display = 'block';
            resultDisplay.classList.add('animate-fadeIn');
            document.getElementById('emptyResult').style.display = 'none';
            
            // Update soil type with icon
            const iconElement = document.getElementById('soilIcon');
            iconElement.innerHTML = `<i class="fas ${result.soilData.icon} animate-bounceIn" style="font-size: 5rem; color: ${result.soilData.color};"></i>`;
            document.getElementById('soilName').textContent = 
                `${result.soilData.name} (${result.soilData.nameEn})`;
            
            // Update confidence bar with animation
            const confidencePercent = (result.confidence * 100).toFixed(1);
            const confidenceFill = document.getElementById('confidenceFill');
            
            // Reset and animate
            confidenceFill.style.width = '0%';
            setTimeout(() => {
                confidenceFill.style.width = `${confidencePercent}%`;
                confidenceFill.textContent = `${confidencePercent}%`;
            }, 100);
            
            // Update values with animation
            document.getElementById('phValue').textContent = result.phValue;
            document.getElementById('moistureValue').textContent = result.moistureValue;
            document.getElementById('tempValue').textContent = result.tempValue;
            
            // Update recommendations with animation
            const recList = document.getElementById('recommendationsList');
            recList.innerHTML = '';
            result.soilData.recommendations.forEach((rec, index) => {
                setTimeout(() => {
                    const item = document.createElement('div');
                    item.className = 'recommendation-item animate-slideInLeft';
                    item.innerHTML = `
                        <i class="fas ${rec.icon}"></i>
                        <span>${rec.text}</span>
                    `;
                    recList.appendChild(item);
                }, index * 100);
            });
            
            // Update suitable plants with animation
            const plantsList = document.getElementById('suitablePlantsList');
            plantsList.innerHTML = '';
            result.soilData.suitablePlants.forEach((plant, index) => {
                setTimeout(() => {
                    const plantCard = document.createElement('div');
                    plantCard.className = 'plant-card animate-slideInUp';
                    plantCard.innerHTML = `
                        <div class="plant-icon">${plant.icon}</div>
                        <div class="plant-name">${plant.name}</div>
                        <div class="plant-type">${plant.type}</div>
                    `;
                    plantsList.appendChild(plantCard);
                }, index * 50);
            });
            
            // Store current result
            window.currentResult = result;
        }
        
        // ============================================
        // Camera Functions
        // ============================================
        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentCamera } 
                });
                cameraStream = stream;
                document.getElementById('cameraVideo').srcObject = stream;
                document.getElementById('cameraModal').style.display = 'block';
            } catch (error) {
                showMessage('ไม่สามารถเปิดกล้องได้', 'error');
            }
        }
        
        function switchCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            openCamera();
        }
        
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            canvas.toBlob((blob) => {
                const file = new File([blob], `camera-${Date.now()}.jpg`, { type: 'image/jpeg' });
                handleSingleFile(file);
                closeCamera();
            }, 'image/jpeg', 0.9);
        }
        
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').style.display = 'none';
        }
        
        // ============================================
        // History Management
        // ============================================
        function saveToHistory() {
            if (!window.currentResult) {
                showMessage('ไม่มีผลการวิเคราะห์', 'error');
                return;
            }
            
            // Create compressed version for history
            const compressedResult = {
                ...window.currentResult,
                imageData: null, // Don't save image in history
                timestamp: window.currentResult.timestamp || new Date()
            };
            
            analysisHistory.push(compressedResult);
            
            // Keep only last 20 records
            if (analysisHistory.length > 20) {
                analysisHistory = analysisHistory.slice(-20);
            }
            
            saveHistoryToStorage();
            updateHistoryView();
            
            showToast('บันทึกผลการวิเคราะห์แล้ว', 'success');
        }
        
        function saveHistoryToStorage() {
            try {
                localStorage.setItem('soilAnalysisHistory', JSON.stringify(analysisHistory));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showMessage('พื้นที่เก็บข้อมูลเต็ม กรุณาล้างประวัติเก่า', 'error');
                    clearOldData();
                }
            }
        }
        
        function loadHistory() {
            try {
                const saved = localStorage.getItem('soilAnalysisHistory');
                if (saved) {
                    analysisHistory = JSON.parse(saved);
                    updateHistoryView();
                }
            } catch (e) {
                console.error('Error loading history:', e);
                analysisHistory = [];
            }
        }
        
        function updateHistoryView() {
            const container = document.getElementById('historyContent');
            
            if (analysisHistory.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-light);">ยังไม่มีประวัติการวิเคราะห์</p>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;"><table class="history-table"><thead><tr>';
            html += '<th>วันที่/เวลา</th><th>ประเภทดิน</th><th>pH</th><th>ความชื้น</th><th>อุณหภูมิ</th><th>ความมั่นใจ</th><th>การดำเนินการ</th>';
            html += '</tr></thead><tbody>';
            
            analysisHistory.slice().reverse().forEach((item, index) => {
                const date = new Date(item.timestamp);
                const icon = `<i class="fas ${item.soilData.icon}" style="color: ${item.soilData.color};"></i>`;
                html += `<tr>
                    <td>${date.toLocaleString('th-TH')}</td>
                    <td>${icon} ${item.soilData.name}</td>
                    <td>${item.phValue || '-'}</td>
                    <td>${item.moistureValue || '-'}</td>
                    <td>${item.tempValue ? item.tempValue + '°C' : '-'}</td>
                    <td>${(item.confidence * 100).toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewHistoryItem(${analysisHistory.length - 1 - index})" style="padding: 5px 15px; font-size: 0.9rem;">
                            <i class="fas fa-eye"></i> ดู
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function viewHistoryItem(index) {
            const item = analysisHistory[index];
            displayResults(item);
            
            // Scroll to results
            document.getElementById('analyze').scrollIntoView({ behavior: 'smooth' });
            
            showToast('กำลังแสดงผลจากประวัติ', 'info');
        }
        
        function clearHistory() {
            if (confirm('ต้องการล้างประวัติทั้งหมดหรือไม่?')) {
                analysisHistory = [];
                saveHistoryToStorage();
                updateHistoryView();
                showToast('ล้างประวัติแล้ว', 'success');
            }
        }
        
        // ============================================
        // Export Functions
        // ============================================
        function exportToPDF() {
            if (!window.currentResult) {
                showMessage('ไม่มีผลการวิเคราะห์', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add custom font for Thai
            doc.addFont('https://fonts.googleapis.com/css2?family=Prompt', 'Prompt', 'normal');
            
            // Header
            doc.setFontSize(24);
            doc.setTextColor(16, 185, 129);
            doc.text('SoilAI Pro - รายงานการวิเคราะห์ดิน', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(12);
            doc.setTextColor(55, 65, 81);
            doc.text(`วันที่: ${new Date().toLocaleDateString('th-TH')}`, 20, 40);
            doc.text(`เวลา: ${new Date().toLocaleTimeString('th-TH')}`, 20, 50);
            
            // Divider
            doc.setDrawColor(229, 231, 235);
            doc.line(20, 60, 190, 60);
            
            // Results
            doc.setFontSize(16);
            doc.setTextColor(16, 185, 129);
            doc.text('ผลการวิเคราะห์', 20, 75);
            
            doc.setFontSize(14);
            doc.setTextColor(55, 65, 81);
            doc.text(`ประเภทดิน: ${window.currentResult.soilData.name} (${window.currentResult.soilData.nameEn})`, 20, 90);
            doc.text(`ความมั่นใจ: ${(window.currentResult.confidence * 100).toFixed(1)}%`, 20, 100);
            doc.text(`ค่า pH: ${window.currentResult.phValue}`, 20, 110);
            doc.text(`ความชื้น: ${window.currentResult.moistureValue}`, 20, 120);
            doc.text(`อุณหภูมิที่เหมาะสม: ${window.currentResult.tempValue}°C`, 20, 130);
            
            // Recommendations
            doc.setFontSize(16);
            doc.setTextColor(16, 185, 129);
            doc.text('คำแนะนำการดูแลดิน', 20, 150);
            
            let yPos = 165;
            doc.setFontSize(12);
            doc.setTextColor(55, 65, 81);
            window.currentResult.soilData.recommendations.forEach((rec, index) => {
                const text = `${index + 1}. ${rec.text}`;
                const lines = doc.splitTextToSize(text, 170);
                lines.forEach(line => {
                    doc.text(line, 25, yPos);
                    yPos += 7;
                });
                yPos += 3;
            });
            
            // Suitable plants
            if (yPos < 250) {
                doc.setFontSize(16);
                doc.setTextColor(16, 185, 129);
                doc.text('พืชที่เหมาะสม', 20, yPos + 15);
                
                yPos += 30;
                doc.setFontSize(12);
                doc.setTextColor(55, 65, 81);
                const plants = window.currentResult.soilData.suitablePlants.map(p => p.name).join(', ');
                const plantLines = doc.splitTextToSize(plants, 170);
                plantLines.forEach(line => {
                    doc.text(line, 25, yPos);
                    yPos += 7;
                });
            }
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text('Generated by SoilAI Pro - www.soilai.com', 105, 280, { align: 'center' });
            
            // Save
            doc.save(`soil-analysis-${Date.now()}.pdf`);
            showToast('ดาวน์โหลด PDF แล้ว', 'success');
        }
        
        function exportHistory(format) {
            if (analysisHistory.length === 0) {
                showMessage('ไม่มีประวัติการวิเคราะห์', 'error');
                return;
            }
            
            if (format === 'csv') {
                let csv = 'วันที่,เวลา,ประเภทดิน,pH,ความชื้น,อุณหภูมิ (°C),ความมั่นใจ (%),พืชที่เหมาะสม\n';
                
                analysisHistory.forEach(item => {
                    const date = new Date(item.timestamp);
                    const plants = item.soilData.suitablePlants ? 
                        item.soilData.suitablePlants.map(p => p.name).slice(0, 5).join(' / ') : '';
                    
                    csv += `${date.toLocaleDateString('th-TH')},`;
                    csv += `${date.toLocaleTimeString('th-TH')},`;
                    csv += `${item.soilData.name},`;
                    csv += `${item.phValue || '-'},`;
                    csv += `${item.moistureValue || '-'},`;
                    csv += `${item.tempValue || '-'},`;
                    csv += `${(item.confidence * 100).toFixed(1)},`;
                    csv += `"${plants}"\n`;
                });
                
                // Download CSV
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `soil-analysis-history-${Date.now()}.csv`;
                link.click();
                
                showToast('ดาวน์โหลด CSV แล้ว', 'success');
                
            } else if (format === 'json') {
                const data = analysisHistory.map(item => ({
                    date: item.timestamp,
                    soilType: item.soilData.name,
                    soilTypeEn: item.soilData.nameEn,
                    confidence: (item.confidence * 100).toFixed(1) + '%',
                    ph: item.phValue,
                    moisture: item.moistureValue,
                    temperature: item.tempValue,
                    recommendations: item.soilData.recommendations.map(r => r.text),
                    suitablePlants: item.soilData.suitablePlants.map(p => p.name)
                }));
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `soil-analysis-history-${Date.now()}.json`;
                link.click();
                
                showToast('ดาวน์โหลด JSON แล้ว', 'success');
            }
        }
        
        function shareResult() {
            if (!window.currentResult) {
                showMessage('ไม่มีผลการวิเคราะห์', 'error');
                return;
            }
            
            const plants = window.currentResult.soilData.suitablePlants
                .slice(0, 5)
                .map(p => p.name)
                .join(', ');
            const text = `ผลวิเคราะห์ดิน SoilAI Pro:\n\nประเภทดิน: ${window.currentResult.soilData.name}\nความมั่นใจ: ${(window.currentResult.confidence * 100).toFixed(1)}%\npH: ${window.currentResult.phValue}\nความชื้น: ${window.currentResult.moistureValue}\nอุณหภูมิ: ${window.currentResult.tempValue}°C\n\nพืชที่เหมาะสม: ${plants}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'ผลวิเคราะห์ดิน - SoilAI Pro',
                    text: text,
                    url: window.location.href
                }).then(() => {
                    showToast('แชร์สำเร็จ', 'success');
                }).catch(err => {
                    console.log('Share cancelled');
                });
            } else {
                // Copy to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    showToast('คัดลอกผลลัพธ์แล้ว', 'success');
                }).catch(() => {
                    showMessage('ไม่สามารถคัดลอกได้', 'error');
                });
            }
        }
        
        // ============================================
        // Theme Management
        // ============================================
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            // Update icon with animation
            const icon = document.getElementById('themeIcon');
            icon.style.transform = 'rotate(180deg)';
            setTimeout(() => {
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                icon.style.transform = 'rotate(0deg)';
            }, 150);
        }
        
        function checkTheme() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
        }
        
        // ============================================
        // Utility Functions
        // ============================================
        function resetUpload() {
            document.getElementById('imageInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('analyzeBtn').style.display = 'none';
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('emptyResult').style.display = 'block';
            
            hideMessage();
            showToast('รีเซ็ตแล้ว', 'info');
        }
        
        function updateStats() {
            document.getElementById('analyzeCount').textContent = analyzeCount;
        }
        
        function showMessage(message, type) {
            hideMessage();
            
            let element;
            if (type === 'error') {
                element = document.getElementById('errorMessage');
            } else if (type === 'success') {
                element = document.getElementById('successMessage');
            }
            
            if (element) {
                element.querySelector('span').textContent = message;
                element.style.display = 'flex';
                
                // Auto hide after 5 seconds
                setTimeout(hideMessage, 5000);
            }
        }
        
        function hideMessage() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon} toast-icon"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ============================================
        // Performance Optimizations
        // ============================================
        // Intersection Observer for animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);
        
        // Observe elements with animations
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.feature-card, .stat-card').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'all 0.6s ease-out';
                observer.observe(el);
            });
        });
        
        // ============================================
        // Keyboard Shortcuts
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + O = Open file
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                document.getElementById('imageInput').click();
            }
            
            // Ctrl/Cmd + S = Save to history
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveToHistory();
            }
            
            // Ctrl/Cmd + E = Export PDF
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportToPDF();
            }
            
            // Ctrl/Cmd + D = Toggle dark mode
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
        });
        
        // ============================================
        // Recent Analyses Management with Size Limit
        // ============================================
        function saveToRecent(result) {
            try {
                // Get recent analyses from localStorage
                let recentAnalyses = JSON.parse(localStorage.getItem('recentAnalyses') || '[]');
                
                // Create a lighter version of result (without full image)
                const lightResult = {
                    ...result,
                    imageData: result.imageData ? result.imageData.substring(0, 100) + '...' : null,
                    thumbnail: result.imageData ? result.imageData : null
                };
                
                // Add new result to beginning
                recentAnalyses.unshift(lightResult);
                
                // Keep only last 3 (reduced from 5)
                recentAnalyses = recentAnalyses.slice(0, 3);
                
                // Save back to localStorage
                localStorage.setItem('recentAnalyses', JSON.stringify(recentAnalyses));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn('Storage quota exceeded, clearing old data...');
                    clearOldData();
                }
            }
        }
        
        // ============================================
        // Error Handling
        // ============================================
        window.addEventListener('error', (e) => {
            console.error('Global error:', e);
            
            // Don't show error for tensor disposal warnings or backend errors
            if (e.message && (e.message.includes('Tensor is disposed') || 
                             e.message.includes('backend') ||
                             e.message.includes('tf is not defined'))) {
                return;
            }
            
            showToast('เกิดข้อผิดพลาด กรุณาลองใหม่', 'error');
        });
        
        // Handle offline/online
        window.addEventListener('offline', () => {
            showToast('ไม่มีการเชื่อมต่ออินเทอร์เน็ต', 'error');
        });
        
        window.addEventListener('online', () => {
            showToast('กลับมาออนไลน์แล้ว', 'success');
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            // Dispose of TensorFlow resources
            if (model && model.dispose) {
                model.dispose();
            }
            
            // Stop camera stream if active
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
